<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ Administration</title>
    <link rel="stylesheet" href="../../shared/css/navigation.css">
    <link rel="stylesheet" href="../../shared/css/modals.css">
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>ğŸ‘‘ Panneau d'Administration</h1>
        </header>

        <!-- Onglets de navigation admin -->
        <nav class="admin-tabs">
            <button class="admin-tab-btn active" data-tab="users">ğŸ‘¥ Utilisateurs</button>
            <button class="admin-tab-btn" data-tab="cards">ğŸƒ Cartes & ThÃ¨mes</button>
        </nav>

        <main class="admin-content">
            <!-- Section Utilisateurs -->
            <section id="users-section" class="admin-section active">
                <div class="section-header">
                    <h2>ğŸ‘¥ Gestion des Utilisateurs</h2>
                    <button id="create-user-btn" class="admin-btn-primary">â• CrÃ©er un compte</button>
                </div>
                <div class="users-search">
                    <input type="text" id="users-search-input" placeholder="ğŸ” Rechercher par nom ou email..." autocomplete="search-users-filter">
                </div>
                <div class="users-list" id="users-list">
                    <!-- Liste des utilisateurs chargÃ©e dynamiquement -->
                </div>
            </section>

            <!-- Section Cartes & ThÃ¨mes -->
            <section id="cards-section" class="admin-section">
                <div class="section-header">
                    <h2>ğŸƒ Gestion des Cartes & ThÃ¨mes</h2>
                    <div class="section-actions">
                        <button id="create-theme-btn" class="admin-btn-secondary">ğŸ¨ Nouveau thÃ¨me</button>
                        <button id="create-card-btn" class="admin-btn-primary">â• Nouvelle carte</button>
                    </div>
                </div>

                <div class="cards-filters">
                    <select id="cards-rarity-filter">
                        <option value="">Toutes les raretÃ©s</option>
                        <option value="common">ğŸ¤ Commune</option>
                        <option value="rare">ğŸ’™ Rare</option>
                        <option value="very_rare">ğŸ’š TrÃ¨s Rare</option>
                        <option value="epic">ğŸ’› Ã‰pique</option>
                        <option value="legendary">â¤ï¸ LÃ©gendaire</option>
                    </select>
                </div>

                <div id="cards-by-theme-container">
                    <!-- Cartes groupÃ©es par thÃ¨me chargÃ©es dynamiquement -->
                </div>
            </section>
        </main>

        <!-- Modal pour crÃ©er/Ã©diter un utilisateur -->
        <div id="user-modal" class="modal">
            <div class="modal-content">
                <span class="close" id="user-modal-close">&times;</span>
                <h2 id="user-modal-title">CrÃ©er un utilisateur</h2>
                <form id="user-form" class="admin-form">
                    <input type="hidden" id="user-id">

                    <div class="form-group">
                        <label for="user-username">Nom d'utilisateur :</label>
                        <input type="text" id="user-username" required>
                    </div>

                    <div class="form-group">
                        <label for="user-email">Email :</label>
                        <input type="email" id="user-email" required>
                    </div>

                    <div class="form-group" id="user-password-group">
                        <label for="user-password">Mot de passe :</label>
                        <input type="password" id="user-password">
                        <small>Laisser vide pour ne pas changer le mot de passe</small>
                    </div>

                    <div class="form-group" id="user-credits-group" style="display: none;">
                        <label for="user-credits-adjustment">Ajuster les crÃ©dits :</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="user-credits-adjustment" value="0" style="width: 150px; text-align: center;" placeholder="Ex: +10 ou -5">
                            <button type="button" class="admin-btn-success" id="user-credits-add-btn">â• Ajouter</button>
                            <button type="button" class="admin-btn-danger" id="user-credits-remove-btn">â– Retirer</button>
                        </div>
                        <small>Valeurs positives pour ajouter, nÃ©gatives pour retirer (ex: 10 ou -5)</small>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="user-is-admin">
                            Administrateur
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="admin-btn-primary">ğŸ’¾ Enregistrer</button>
                        <button type="button" id="user-form-cancel" class="admin-btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal pour crÃ©er/Ã©diter une carte -->
        <div id="card-modal" class="modal">
            <div class="modal-content">
                <span class="close" id="card-modal-close">&times;</span>
                <h2 id="card-modal-title">CrÃ©er une carte</h2>
                <form id="card-form" class="admin-form">
                    <input type="hidden" id="card-id">

                    <div class="form-group">
                        <label for="card-name">Nom de la carte :</label>
                        <input type="text" id="card-name" required>
                    </div>

                    <div class="form-group">
                        <label for="card-description">Description :</label>
                        <textarea id="card-description" rows="3" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="card-theme">ThÃ¨me :</label>
                        <select id="card-theme" required>
                            <option value="">-- Choisir un thÃ¨me --</option>
                            <option value="minecraft">ğŸŸ« Minecraft</option>
                            <option value="space">ğŸŒŒ Astronomie</option>
                            <option value="dinosaurs">ğŸ¦• Dinosaures</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="card-rarity">RaretÃ© :</label>
                        <select id="card-rarity" required>
                            <option value="">-- Choisir une raretÃ© --</option>
                            <option value="common">ğŸ¤ Commune (60%)</option>
                            <option value="rare">ğŸ’™ Rare (25%)</option>
                            <option value="very_rare">ğŸ’š TrÃ¨s Rare (10%)</option>
                            <option value="epic">ğŸ’› Ã‰pique (4%)</option>
                            <option value="legendary">â¤ï¸ LÃ©gendaire (1%)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="card-image">URL de l'image :</label>
                        <input type="url" id="card-image" required>
                        <small>URL d'une image hÃ©bergÃ©e en ligne</small>
                    </div>

                    <div class="form-group">
                        <label>AperÃ§u de l'image :</label>
                        <div class="card-preview">
                            <img id="card-preview-img" src="" alt="AperÃ§u" style="display: none;">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="admin-btn-primary">ğŸ’¾ Enregistrer</button>
                        <button type="button" id="card-form-cancel" class="admin-btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal pour crÃ©er/Ã©diter un thÃ¨me -->
        <div id="theme-modal" class="modal">
            <div class="modal-content">
                <span class="close" id="theme-modal-close">&times;</span>
                <h2 id="theme-modal-title">CrÃ©er un thÃ¨me</h2>
                <form id="theme-form" class="admin-form">
                    <input type="hidden" id="theme-id">

                    <div class="form-group">
                        <label for="theme-slug">Identifiant (slug) :</label>
                        <input type="text" id="theme-slug" required pattern="[a-z0-9_-]+" placeholder="ex: dinosaurs">
                        <small>Utilisez uniquement des lettres minuscules, chiffres, tirets et underscores</small>
                    </div>

                    <div class="form-group">
                        <label for="theme-name">Nom du thÃ¨me :</label>
                        <input type="text" id="theme-name" required placeholder="ex: Dinosaures">
                    </div>

                    <div class="form-group">
                        <label for="theme-icon">IcÃ´ne (emoji) :</label>
                        <input type="text" id="theme-icon" required maxlength="2" placeholder="ex: ğŸ¦•">
                        <small>Choisissez un emoji reprÃ©sentant le thÃ¨me</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="admin-btn-primary">ğŸ’¾ Enregistrer</button>
                        <button type="button" id="theme-form-cancel" class="admin-btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast pour les notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <script src="../../shared/js/config.js"></script>
    <!-- Modal system -->
    <script src="../../shared/js/modals.js"></script>
    <!-- Auth system -->
    <script src="../../shared/js/auth.js"></script>
    <!-- Navigation system -->
    <script src="../../shared/js/navigation.js"></script>
    <!-- Admin scripts -->
    <script src="js/admin-ui.js"></script>
    <script src="js/admin-users.js"></script>
    <script src="js/admin-cards.js"></script>
    <script src="js/admin-app.js"></script>

    <!-- Auth initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸ”§ Admin page: Starting authentication check');

                // Initialiser l'authentification
                const isAuth = await authService.init();
                console.log('ğŸ”§ Admin page: isAuth =', isAuth);
                console.log('ğŸ”§ Admin page: currentUser =', authService.getCurrentUser());
                console.log('ğŸ”§ Admin page: isAdmin =', authService.isAdmin());

                if (!isAuth) {
                    // Pas authentifiÃ©, rediriger vers la page de connexion
                    console.log('âŒ User not authenticated, redirecting to login');
                    window.location.href = '/';
                    return;
                }

                // VÃ©rifier si l'utilisateur est admin
                if (!authService.isAdmin()) {
                    // Pas admin, rediriger vers l'accueil
                    console.log('âŒ User is not admin, redirecting to home');
                    await alert('AccÃ¨s rÃ©servÃ© aux administrateurs');
                    window.location.href = '/modules/cards/index.html';
                    return;
                }

                console.log('âœ… User is admin, initializing admin panel');

                // Utilisateur admin authentifiÃ©, initialiser la navigation d'abord
                await navigationUI.init();

                // PUIS initialiser les modules admin (qui ont besoin du token)
                await initAdminPanel();
            } catch (error) {
                console.error('âŒ Error during authentication:', error);
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>
